rules_version = '2';
service cloud.firestore {
    match /databases/{database}/documents {
      function isSignedIn() { return request.auth != null; }

      // User profiles
      match /users/{uid} {
        allow read, create, update: if isSignedIn() && request.auth.uid == uid;
        allow delete: if false;
      }

      // Allow the authenticated user to read/write their own subcollections under users/{uid}
      // Needed for per-user chat metadata (dmMeta), blocked lists, etc.
      match /users/{uid}/{document=**} {
        allow read, create, update, delete: if isSignedIn() && request.auth.uid == uid;
      }

      // Chats (grupales)
      match /chats/{chatId} {
        // Allow signed-in users to read chat container docs (if any)
        allow read: if isSignedIn();

        // Junta subcollection (reuniones)
        match /junta/{juntaId} {
          allow read, write: if isSignedIn();
        }

        // Messages subcollection
        match /messages/{messageId} {
          allow read: if isSignedIn();

          // Create messages for self only, with sane shape
          allow create: if isSignedIn()
            && request.resource.data.uid == request.auth.uid
            && request.resource.data.keys().hasOnly(['type','text','uid','email','createdAt','juntaId','creatorUid','creatorEmail','hora','slot','lugar','linea','direccion'])
            && (
              (request.resource.data.type == 'text' && request.resource.data.text is string && request.resource.data.text.size() > 0 && request.resource.data.text.size() <= 2000)
              ||
              (request.resource.data.type == 'junta')
            );

          // Only the author can delete their own message
          allow delete: if isSignedIn() && resource.data.uid == request.auth.uid;

          // Avoid arbitrary updates to existing messages
          allow update: if false;
        }

        // Typing indicator subcollection
        match /typing/{userId} {
          allow read: if isSignedIn();

          // Only the owner can create/update/delete their typing doc
          allow create, update: if isSignedIn()
            && userId == request.auth.uid
            && request.resource.data.keys().hasOnly(['uid','email','updatedAt'])
            && request.resource.data.uid == request.auth.uid;
          allow delete: if isSignedIn() && userId == request.auth.uid;
        }
      }

      // Private (direct) messages between two users
      match /dmChats/{chatId} {
        allow read: if isSignedIn() && (request.auth.uid in resource.data.participants);

        // Create DM doc must include current user in participants
        allow create: if isSignedIn()
          && (request.resource.data.participants is list)
          && request.resource.data.participants.size() == 2
          && (request.auth.uid in request.resource.data.participants)
          && request.resource.data.participants[0] != request.resource.data.participants[1]
          && (request.resource.data.participantEmails is map);

        // Only participants can update metadata
        allow update: if isSignedIn() && (
          (resource.data.participants is list && request.auth.uid in resource.data.participants)
          ||
          ((request.resource.data.participants is list)
            && request.resource.data.participants.size() == 2
            && request.resource.data.participants[0] != request.resource.data.participants[1]
            && (request.auth.uid in request.resource.data.participants))
        );

        match /messages/{messageId} {
          // Solo participantes pueden leer
          allow read: if isSignedIn() && (request.auth.uid in get(/databases/$(database)/documents/dmChats/$(chatId)).data.participants);

          // Solo participantes pueden crear su propio mensaje (permitiendo readBy vacío)
          allow create: if isSignedIn()
            && (request.auth.uid in get(/databases/$(database)/documents/dmChats/$(chatId)).data.participants)
            && request.resource.data.uid == request.auth.uid
            && request.resource.data.keys().hasOnly(['text','uid','email','createdAt','readBy'])
            && request.resource.data.text is string
            && request.resource.data.text.size() > 0
            && request.resource.data.text.size() <= 2000
            && (request.resource.data.readBy is list);

          // Solo el autor puede borrar su mensaje
          allow delete: if isSignedIn()
            && (request.auth.uid in get(/databases/$(database)/documents/dmChats/$(chatId)).data.participants)
            && resource.data.uid == request.auth.uid;

          // Permitir actualizar el campo readBy aunque se agregue por primera vez
          allow update: if isSignedIn()
            && (request.auth.uid in get(/databases/$(database)/documents/dmChats/$(chatId)).data.participants)
            && request.resource.data.keys().hasAll(resource.data.keys())
            && request.resource.data.diff(resource.data).changedKeys().hasOnly(['readBy']);
        }
      }

      // Permitir collectionGroup queries sobre cualquier subcolección junta
      match /{document=**}/junta/{juntaId} {
        allow read: if isSignedIn();
      }
    }
  }

